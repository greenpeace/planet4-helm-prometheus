---
additionalPrometheusRulesMap:
  planet4:
    groups:
      - name: p4_websites
        rules:
          - alert: ThanosCompactHasNotRun
            annotations:
              description: |-
                "Thanos Compact {{$labels.job}} has not uploaded anything
                for 24 hours."
              observability_url: >-
                https://grafana.greenpeace.org/d/na0nQDXGk/planet4-end-point-monitoring?orgId=1&var-target={{$labels.instance}}
              gitlab_incident_markdown: |
                /label  ~\"Terraform Deployment\"\n Probe slow
            expr: >-
              (
                time() - max by (job) (
                  max_over_time(
                    thanos_objstore_bucket_last_successful_upload_time{job=~".*thanos-compact.*"}[24h]
                  )
                )
              ) / 60 / 60 > 24
            for: 0m
            labels:
              email_contact: pops@greenpeace.org
              gitlab_project: planet4-documentation-and-issues
              severity: critical
              slack_channel: p4-slack-alert
          - alert: ThanosQueryHttpRequestQueryErrorRateHigh
            annotations:
              description: |-
                "Thanos Query {{$labels.job}} is failing to handle
                {{$value | humanize}}% of "query" requests.\n
                VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
              observability_url: >-
                https://grafana.greenpeace.org/d/na0nQDXGk/planet4-end-point-monitoring?orgId=1&var-target={{$labels.instance}}
              gitlab_incident_markdown: |
                /label  ~\"Terraform Deployment\"\n Probe slow
            expr: >-
              (
                sum by (job) (
                  rate(http_requests_total{
                    code=~"5..",
                    job=~".*thanos-query.*",
                    handler="query"
                  }[5m])
                ) /
                sum by (job) (
                  rate(http_requests_total{
                    job=~".*thanos-query.*",
                    handler="query"
                  }[5m])
                )
              ) * 100 > 5
            for: 5m
            labels:
              email_contact: pops@greenpeace.org
              gitlab_project: planet4-documentation-and-issues
              severity: critical
              slack_channel: p4-slack-alert
          - alert: ThanosSidecarBucketOperationsFailed
            annotations:
              description: |-
                Thanos Sidecar {{$labels.instance}}
                bucket operations are failing.
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
              observability_url: >-
                https://grafana.greenpeace.org/d/na0nQDXGk/planet4-end-point-monitoring?orgId=1&var-target={{$labels.instance}}
              summary: |-
                Thanos Sidecar Bucket Ops
                Failed (instance {{ $labels.instance }})
              gitlab_incident_markdown: |
                /label  ~\"Terraform Deployment\"\n Probe slow
            expr: >-
              sum by (job, instance) (
                rate(thanos_objstore_bucket_operation_failures_total{
                  job=~".*thanos-sidecar.*"
                }[5m])
              ) > 0
            for: 5m
            labels:
              email_contact: pops@greenpeace.org
              gitlab_project: planet4-documentation-and-issues
              severity: critical
              slack_channel: p4-slack-alert
          - alert: ThanosSidecarNoConnectionToStartedPrometheus
            annotations:
              description: |-
                Thanos Sidecar {{$labels.instance}} is unhealthy.
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
              observability_url: >-
                https://grafana.greenpeace.org/d/na0nQDXGk/planet4-end-point-monitoring?orgId=1&var-target={{$labels.instance}}
              summary: |-
                Thanos Sidecar No Connection
                To Started Prometheus (instance {{ $labels.instance }})
              gitlab_incident_markdown: |
                /label  ~\"Terraform Deployment\"\n Probe slow
            expr: >-
              thanos_sidecar_prometheus_up{
                job=~".*thanos-sidecar.*"
                } == 0
              and on (namespace, pod)
              prometheus_tsdb_data_replay_duration_seconds != 0
            for: 5m
            labels:
              email_contact: pops@greenpeace.org
              gitlab_project: planet4-documentation-and-issues
              severity: critical
              slack_channel: "p4-slack-alert,planet4-test"
          - alert: TestAlert
            expr: 1
            for: 1m
            labels:
              severity: test
              slack_channel: "p4-slack-alert,planet4-test"
            annotations:
              summary: "Test Alert: This is a test alert!"
              description: "test alert generated for verification purposes."
